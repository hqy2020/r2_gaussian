# 实现新功能的完整工作流

## 典型场景：将论文创新点迁移到 R²-Gaussian

**注意**：以下每个阶段都必须遵循【分析问题】→【制定方案】→【执行方案】的三阶段工作流。

---

## 阶段 1：创新点分析（3DGS + 医学专家）

### 【分析问题】
1. **[3DGS 专家]** 在 `cc-agent/3dgs_expert/` 创建任务记录
   ```bash
   cd cc-agent/3dgs_expert
   # 更新 record.md：当前分析 arXiv:2024.xxxxx
   ```

2. **使用 Graphiti MCP 工具**：
   - 使用 `search_nodes` 查找相关的偏好设置和程序（如"论文分析流程"、"创新点提取方法"等）
   - 使用 `search_facts` 发现相关的历史分析经验和知识

3. **使用 serena MCP 工具**：
   - 使用 `find_symbol` 定位 R²-Gaussian 中相关的类和函数
   - 使用 `find_referencing_symbols` 分析使用位置
   - 找到所有相关的代码文件和行号

4. 使用 MCP arXiv 工具获取论文，提取：
   - 核心算法改进
   - 新的损失函数
   - 网络结构变化

5. 识别问题根因：分析创新点与现有实现的差异和冲突点

### 【制定方案】
- 列出需要分析的关键点
- 确定分析文档的结构
- 识别需要用户决策的问题（如：是否继续实现、优先级等）

### 【执行方案】
- 生成 `innovation_analysis.md`
- **✋ 检查点 1：** 等待用户确认是否继续实现

---

## 阶段 2：技术方案设计（3DGS 专家）

### 【分析问题】
1. **使用 Graphiti MCP 工具**：
   - 搜索相关的技术方案设计偏好和程序
   - 查找类似功能的实现历史

2. **使用 serena MCP 工具**：
   - 分析需要修改的文件（如 `train.py`, `gaussian_model.py`）
   - 识别影响范围和依赖关系

3. 分析技术挑战和风险点

### 【制定方案】
1. 在 `cc-agent/3dgs_expert/implementation_plans/` 创建详细方案
   - 需修改的文件列表（如 `train.py`, `gaussian_model.py`）
   - 新增的算法模块（放在 `r2_gaussian/utils/`）
   - 预期的技术挑战
   - 消除重复逻辑的方案

2. **使用 Graphiti MCP 工具**：
   - 将技术方案记录为程序（如果这是可复用的设计模式）
   - 记录关键的技术决策作为事实

### 【执行方案】
- **✋ 检查点 2：** 等待用户确认，审核技术路线

---

## 阶段 3：代码实现（编程专家）

### 【分析问题】
1. **[编程专家]** 在 `cc-agent/code/` 工作
   ```bash
   cd cc-agent/code
   # 更新 record.md：当前实现 XXX 功能
   ```

2. **使用 Graphiti MCP 工具**：
   - 搜索代码实现相关的偏好和程序
   - 查找代码风格和架构设计的事实

3. **使用 serena MCP 工具**：
   - 使用 `find_symbol` 定位需要修改的类和函数
   - 使用 `find_referencing_symbols` 分析所有使用位置
   - 识别重复代码和不合理的设计

4. 使用 MCP GitHub 工具查阅原论文代码
   - 克隆仓库到 `cc-agent/论文/archived/<paper_name>/code_repo/`
   - 理解实现细节，记录到 `github_research/`

### 【制定方案】
1. 列出变更（新增、修改、删除）的文件，简要描述每个文件的变化
2. 消除重复逻辑：如果发现重复代码，必须通过复用或抽象来消除
3. 确保修改后的代码符合 DRY 原则和良好的架构设计
4. 生成 `code_review.md`：
   - 修改的文件和函数列表
   - 新增的依赖库
   - 潜在兼容性风险

### 【执行方案】
- **✋ 检查点 3：** 等待用户确认，批准代码修改
- 新增代码放在 `cc-agent/code/scripts/`，修改 baseline 通过 Git 跟踪
- 实现并集成，确保向下兼容
- 修改后运行类型检查

---

## 阶段 4：实验与调参（调参专家 + 编程专家）

### 【分析问题】
1. **使用 Graphiti MCP 工具**：
   - 搜索实验配置相关的偏好和程序
   - 查找历史实验经验和最佳实践

2. **使用 serena MCP 工具**：
   - 分析训练脚本和参数配置
   - 识别可能影响实验的关键代码路径

### 【制定方案】
1. 制定实验计划：
   - 实验参数配置
   - 监控指标和检查点
   - 失败检测机制

### 【执行方案】
1. **[调参专家]** 执行实验并分析
   - 运行训练命令
   - 实时监控收敛情况（每 N 次迭代检查一次）
   - **失败检测机制：**
     - 如果当前实验的收敛曲线明显低于上一次实验 → **立即停止实验**
     - 如果定量指标（PSNR, SSIM）持续下降或停滞 → **触发失败分析**
   - **失败时自动分析：**
     - 找到表现好的样本和表现差的样本（按 PSNR/SSIM 排序）
     - 可视化对比：好样本 vs 差样本的渲染结果
     - 分析差样本的共同特征（精细结构、边缘、纹理等）
     - 诊断表层原因（损失函数、正则化、采样策略等）
     - 生成 `failure_analysis.md`（包含可视化对比图）
   - 成功时：收集定量指标（PSNR, SSIM）和可视化，诊断性能瓶颈
   - 生成 `result_analysis.md` 或 `failure_analysis.md`

2. **使用 Graphiti MCP 工具**：
   - 将实验配置和结果记录为事实
   - 如果发现有效的实验模式，记录为程序

3. **✋ 检查点 4：** 实验计划前 → 批准实验方案
4. **✋ 检查点 5：** 实验结果后 → 决定下一步优化

