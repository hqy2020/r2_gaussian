#!/bin/bash

###############################################################################
# SSS-v7-OFFICIAL è®­ç»ƒç›‘æŽ§è„šæœ¬
#
# å®žæ—¶æ˜¾ç¤ºè®­ç»ƒè¿›åº¦å’Œå…³é”®æŒ‡æ ‡
# ç”Ÿæˆæ—¥æœŸ: 2025-11-18
###############################################################################

NOHUP_LOG="output/2025_11_18_foot_3views_sss_v7_official_nohup.log"
PID_FILE="output/2025_11_18_foot_3views_sss_v7_official.pid"

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ðŸ“Š SSS-v7-OFFICIAL è®­ç»ƒç›‘æŽ§é¢æ¿                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# æ£€æŸ¥è®­ç»ƒæ˜¯å¦åœ¨è¿è¡Œ
if [ -f "$PID_FILE" ]; then
    TRAIN_PID=$(cat "$PID_FILE")
    if ps -p $TRAIN_PID > /dev/null 2>&1; then
        echo "âœ… è®­ç»ƒè¿›ç¨‹è¿è¡Œä¸­ (PID: $TRAIN_PID)"
        ps -p $TRAIN_PID -o pid,etime,%cpu,%mem,cmd --no-headers
        echo ""
    else
        echo "âš ï¸  è®­ç»ƒè¿›ç¨‹å·²åœæ­¢ (PID: $TRAIN_PID)"
        echo ""
    fi
else
    echo "âš ï¸  æœªæ‰¾åˆ° PID æ–‡ä»¶: $PID_FILE"
    echo ""
fi

# æ£€æŸ¥æ—¥å¿—æ–‡ä»¶
if [ ! -f "$NOHUP_LOG" ]; then
    echo "âŒ æ—¥å¿—æ–‡ä»¶ä¸å­˜åœ¨: $NOHUP_LOG"
    exit 1
fi

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“ˆ æœ€æ–°è®­ç»ƒè¿›åº¦ï¼ˆæœ€åŽ 15 è¡Œï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
grep 'Train:' "$NOHUP_LOG" | tail -15
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸŽ¯ SSS Balance Lossï¼ˆæœ€è¿‘ 5 æ¬¡è®°å½•ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
grep 'SSS-Official.*Iter' "$NOHUP_LOG" | tail -5
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "â™»ï¸  Component Recyclingï¼ˆæœ€è¿‘ 5 æ¬¡è®°å½•ï¼‰"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
grep 'SSS-Recycle' "$NOHUP_LOG" | tail -5 || echo "   ï¼ˆå°šæœªæ‰§è¡Œ recyclingï¼Œéœ€ â‰¥500 æ­¥ï¼‰"
echo ""

echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ“Š å…³é”®ä¿¡æ¯ç»Ÿè®¡"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

# æå–å½“å‰è¿­ä»£æ•°
CURRENT_ITER=$(grep 'Train:' "$NOHUP_LOG" | tail -1 | grep -oP '\d+/30000' | cut -d'/' -f1 || echo "0")
echo "ðŸ”¢ å½“å‰è¿­ä»£: $CURRENT_ITER / 30,000"

# è®¡ç®—è¿›åº¦ç™¾åˆ†æ¯”
if [ "$CURRENT_ITER" -gt 0 ]; then
    PROGRESS=$(awk "BEGIN {printf \"%.1f\", $CURRENT_ITER / 30000 * 100}")
    echo "ðŸ“ˆ è®­ç»ƒè¿›åº¦: $PROGRESS%"
fi

# æå–å½“å‰ loss
CURRENT_LOSS=$(grep 'Train:' "$NOHUP_LOG" | tail -1 | grep -oP 'loss=\K[\d.e+-]+' || echo "N/A")
echo "ðŸ“‰ å½“å‰ Loss: $CURRENT_LOSS"

# ä¼°ç®—å‰©ä½™æ—¶é—´
SPEED=$(grep 'Train:' "$NOHUP_LOG" | tail -1 | grep -oP '[\d.]+it/s' | grep -oP '[\d.]+' || echo "0")
if [ "$SPEED" != "0" ] && [ "$CURRENT_ITER" -gt 0 ]; then
    REMAINING_ITERS=$((30000 - CURRENT_ITER))
    REMAINING_SECS=$(awk "BEGIN {printf \"%.0f\", $REMAINING_ITERS / $SPEED}")
    REMAINING_HOURS=$(awk "BEGIN {printf \"%.1f\", $REMAINING_SECS / 3600}")
    echo "â±ï¸  é¢„è®¡å‰©ä½™: $REMAINING_HOURS å°æ—¶"
fi

echo ""
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo "ðŸ’¡ ç›‘æŽ§å‘½ä»¤"
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
echo ""
echo "  # å®žæ—¶ç›‘æŽ§ï¼ˆæ¯ 30 ç§’åˆ·æ–°ï¼‰"
echo "  watch -n 30 'bash scripts/monitor_sss_v7.sh'"
echo ""
echo "  # å®žæ—¶æŸ¥çœ‹å®Œæ•´æ—¥å¿—"
echo "  tail -f $NOHUP_LOG"
echo ""
echo "  # åœæ­¢è®­ç»ƒ"
echo "  kill $(cat $PID_FILE 2>/dev/null || echo 'PID_NOT_FOUND')"
echo ""
