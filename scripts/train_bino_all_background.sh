#!/bin/bash

###############################################################################
# Bino åå°æ‰¹é‡è®­ç»ƒè„šæœ¬ - æ‰€æœ‰å™¨å®˜ 3 Views
#
# åŠŸèƒ½:
#   - åå°è¿è¡Œæ‰€æœ‰å™¨å®˜çš„è®­ç»ƒä»»åŠ¡
#   - æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹è¿›ç¨‹ï¼Œäº’ä¸å½±å“
#   - è‡ªåŠ¨è®°å½• PID å’Œæ—¥å¿—
#
# ä½¿ç”¨æ–¹æ³•:
#   bash scripts/train_bino_all_background.sh
#
###############################################################################

set -e

# ============================================================================
# é…ç½®
# ============================================================================

# å™¨å®˜åˆ—è¡¨ï¼ˆæŒ‰ç…§ä½ çš„ SOTA åŸºå‡†é¡ºåºï¼‰
ORGANS=("foot" "chest" "head" "abdomen" "pancreas")
NUM_VIEWS=3  # æ‰€æœ‰å™¨å®˜éƒ½ç”¨ 3 views

# å·¥ä½œç›®å½•
WORK_DIR="/home/qyhu/Documents/r2_ours/r2_gaussian"
cd "$WORK_DIR"

# æ—¥å¿—å’Œ PID ç›®å½•
LOG_DIR="$WORK_DIR/output"
PID_DIR="$WORK_DIR"

# ============================================================================
# å¯åŠ¨ä¿¡æ¯
# ============================================================================
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸ”¬ Bino åå°æ‰¹é‡è®­ç»ƒ - æ‰€æœ‰å™¨å®˜ 3 Views                         â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘   å™¨å®˜åˆ—è¡¨: ${ORGANS[@]}"
echo "â•‘   è§†è§’æ•°: ${NUM_VIEWS}"
echo "â•‘   å·¥ä½œç›®å½•: $WORK_DIR"
echo "â•‘   æ—¥å¿—ç›®å½•: $LOG_DIR"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# ============================================================================
# æ¿€æ´» Conda ç¯å¢ƒ
# ============================================================================
echo "ğŸ”§ [Setup] Activating conda environment: r2_gaussian_new"
source $(conda info --base)/etc/profile.d/conda.sh
conda activate r2_gaussian_new

# ============================================================================
# å¯åŠ¨è®­ç»ƒä»»åŠ¡
# ============================================================================

STARTED_TASKS=()
FAILED_TASKS=()

for ORGAN in "${ORGANS[@]}"; do
    echo ""
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    echo "ğŸš€ [Launch] å™¨å®˜: $ORGAN | è§†è§’: $NUM_VIEWS"
    echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

    # æ•°æ®é›†è·¯å¾„
    DATA_PATH="data/369/${ORGAN}_50_${NUM_VIEWS}views.pickle"

    # æ£€æŸ¥æ•°æ®é›†
    if [ ! -f "$DATA_PATH" ]; then
        echo "âš ï¸  [Skip] æ•°æ®é›†ä¸å­˜åœ¨: $DATA_PATH"
        FAILED_TASKS+=("$ORGAN (æ•°æ®é›†ä¸å­˜åœ¨)")
        continue
    fi

    # è¾“å‡ºè·¯å¾„ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
    TIMESTAMP=$(date +"%Y_%m_%d_%H_%M")
    OUTPUT_PATH="output/${TIMESTAMP}_${ORGAN}_${NUM_VIEWS}views_bino"
    LOG_FILE="${OUTPUT_PATH}_train.log"
    PID_FILE="${OUTPUT_PATH}.pid"

    # è®­ç»ƒå‚æ•°
    ITERATIONS=30000
    TEST_ITERATIONS="1000 5000 10000 15000 20000 25000 30000"
    SAVE_ITERATIONS="30000"

    echo "   æ•°æ®é›†: $DATA_PATH"
    echo "   è¾“å‡ºè·¯å¾„: $OUTPUT_PATH"
    echo "   æ—¥å¿—æ–‡ä»¶: $LOG_FILE"
    echo "   PID æ–‡ä»¶: $PID_FILE"
    echo ""

    # å¯åŠ¨è®­ç»ƒï¼ˆåå°è¿è¡Œï¼‰
    nohup python train.py \
        -s "$DATA_PATH" \
        -m "$OUTPUT_PATH" \
        --iterations $ITERATIONS \
        --eval \
        --enable_opacity_decay \
        --opacity_decay_factor 0.995 \
        --test_iterations $TEST_ITERATIONS \
        --save_iterations $SAVE_ITERATIONS \
        > "$LOG_FILE" 2>&1 &

    # è·å–è¿›ç¨‹ PID
    TASK_PID=$!
    echo $TASK_PID > "$PID_FILE"

    echo "âœ… [Started] è®­ç»ƒå·²å¯åŠ¨"
    echo "   PID: $TASK_PID"
    echo "   æŸ¥çœ‹æ—¥å¿—: tail -f $LOG_FILE"
    echo "   åœæ­¢è®­ç»ƒ: kill $TASK_PID"
    echo ""

    STARTED_TASKS+=("$ORGAN (PID: $TASK_PID)")

    # ç­‰å¾… 2 ç§’ï¼Œé¿å… GPU åŒæ—¶åˆå§‹åŒ–å†²çª
    sleep 2
done

# ============================================================================
# å¯åŠ¨æ€»ç»“
# ============================================================================
echo ""
echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸ æ‰€æœ‰ä»»åŠ¡å·²å¯åŠ¨                                                â•‘"
echo "â• â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•£"
echo "â•‘   æˆåŠŸå¯åŠ¨: ${#STARTED_TASKS[@]} ä¸ªä»»åŠ¡"
echo "â•‘   å¤±è´¥/è·³è¿‡: ${#FAILED_TASKS[@]} ä¸ªä»»åŠ¡"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

if [ ${#STARTED_TASKS[@]} -gt 0 ]; then
    echo "âœ… å·²å¯åŠ¨çš„ä»»åŠ¡:"
    for task in "${STARTED_TASKS[@]}"; do
        echo "   â€¢ $task"
    done
    echo ""
fi

if [ ${#FAILED_TASKS[@]} -gt 0 ]; then
    echo "âš ï¸  å¤±è´¥/è·³è¿‡çš„ä»»åŠ¡:"
    for task in "${FAILED_TASKS[@]}"; do
        echo "   â€¢ $task"
    done
    echo ""
fi

# ============================================================================
# ç›‘æ§å‘½ä»¤æç¤º
# ============================================================================
echo "ğŸ“Š [Monitor] ç›‘æ§å‘½ä»¤:"
echo ""
echo "   # æŸ¥çœ‹æ‰€æœ‰è®­ç»ƒè¿›ç¨‹"
echo "   ps aux | grep 'python train.py' | grep -v grep"
echo ""
echo "   # æŸ¥çœ‹ GPU ä½¿ç”¨æƒ…å†µ"
echo "   nvidia-smi"
echo ""
echo "   # å®æ—¶æŸ¥çœ‹æŸä¸ªä»»åŠ¡çš„æ—¥å¿—ï¼ˆæ›¿æ¢ ORGAN ä¸ºå®é™…å™¨å®˜åï¼‰"
echo "   tail -f output/*_ORGAN_3views_bino_train.log"
echo ""
echo "   # åœæ­¢æ‰€æœ‰è®­ç»ƒä»»åŠ¡"
echo "   pkill -f 'python train.py.*bino'"
echo ""
echo "   # æŸ¥çœ‹æ‰€æœ‰ PID æ–‡ä»¶"
echo "   ls -lh output/*_bino.pid"
echo ""

# ============================================================================
# åˆ›å»ºç›‘æ§è„šæœ¬
# ============================================================================
MONITOR_SCRIPT="scripts/monitor_bino_training.sh"
cat > "$MONITOR_SCRIPT" << 'EOF'
#!/bin/bash

# Bino è®­ç»ƒç›‘æ§è„šæœ¬

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ğŸ“Š Bino è®­ç»ƒä»»åŠ¡ç›‘æ§                                             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ğŸ” [Processes] è¿è¡Œä¸­çš„è®­ç»ƒè¿›ç¨‹:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ps aux | grep 'python train.py' | grep bino | grep -v grep || echo "   æ²¡æœ‰è¿è¡Œä¸­çš„ Bino è®­ç»ƒä»»åŠ¡"
echo ""

echo "ğŸ’¾ [GPU] GPU ä½¿ç”¨æƒ…å†µ:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
nvidia-smi --query-gpu=index,name,utilization.gpu,memory.used,memory.total --format=csv,noheader,nounits | \
    awk -F, '{printf "   GPU %s: %s | ä½¿ç”¨ç‡: %3d%% | æ˜¾å­˜: %5d MB / %5d MB\n", $1, $2, $3, $4, $5}'
echo ""

echo "ğŸ“ [PID Files] PID æ–‡ä»¶åˆ—è¡¨:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ls -1 output/*_bino.pid 2>/dev/null | while read pidfile; do
    if [ -f "$pidfile" ]; then
        PID=$(cat "$pidfile")
        ORGAN=$(basename "$pidfile" | sed 's/.*_\(.*\)_[0-9]*views_bino.pid/\1/')
        if ps -p $PID > /dev/null 2>&1; then
            echo "   âœ… $ORGAN (PID: $PID) - è¿è¡Œä¸­"
        else
            echo "   âŒ $ORGAN (PID: $PID) - å·²åœæ­¢"
        fi
    fi
done || echo "   æ²¡æœ‰æ‰¾åˆ° PID æ–‡ä»¶"
echo ""

echo "ğŸ“Š [Latest Results] æœ€æ–°è¯„ä¼°ç»“æœ (5000 æ­¥):"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
for organ in foot chest head abdomen pancreas; do
    EVAL_FILE=$(ls -t output/*_${organ}_3views_bino/eval/iter_005000/eval2d_render_test.yml 2>/dev/null | head -1)
    if [ -f "$EVAL_FILE" ]; then
        PSNR=$(grep "^psnr_2d:" "$EVAL_FILE" | awk '{print $2}')
        SSIM=$(grep "^ssim_2d:" "$EVAL_FILE" | awk '{print $2}')
        printf "   %-10s PSNR: %.4f | SSIM: %.4f\n" "$organ" "$PSNR" "$SSIM"
    fi
done
echo ""
EOF

chmod +x "$MONITOR_SCRIPT"

echo "âœ¨ [Created] ç›‘æ§è„šæœ¬å·²åˆ›å»º: $MONITOR_SCRIPT"
echo "   è¿è¡Œç›‘æ§: bash $MONITOR_SCRIPT"
echo ""
