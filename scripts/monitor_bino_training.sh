#!/bin/bash

# Bino è®­ç»ƒç›‘æŽ§è„šæœ¬

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘   ðŸ“Š Bino è®­ç»ƒä»»åŠ¡ç›‘æŽ§                                             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

echo "ðŸ” [Processes] è¿è¡Œä¸­çš„è®­ç»ƒè¿›ç¨‹:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ps aux | grep 'python train.py' | grep bino | grep -v grep || echo "   æ²¡æœ‰è¿è¡Œä¸­çš„ Bino è®­ç»ƒä»»åŠ¡"
echo ""

echo "ðŸ’¾ [GPU] GPU ä½¿ç”¨æƒ…å†µ:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
nvidia-smi --query-gpu=index,name,utilization.gpu,memory.used,memory.total --format=csv,noheader,nounits | \
    awk -F, '{printf "   GPU %s: %s | ä½¿ç”¨çŽ‡: %3d%% | æ˜¾å­˜: %5d MB / %5d MB\n", $1, $2, $3, $4, $5}'
echo ""

echo "ðŸ“ [PID Files] PID æ–‡ä»¶åˆ—è¡¨:"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
ls -1 output/*_bino.pid 2>/dev/null | while read pidfile; do
    if [ -f "$pidfile" ]; then
        PID=$(cat "$pidfile")
        ORGAN=$(basename "$pidfile" | sed 's/.*_\(.*\)_[0-9]*views_bino.pid/\1/')
        if ps -p $PID > /dev/null 2>&1; then
            echo "   âœ… $ORGAN (PID: $PID) - è¿è¡Œä¸­"
        else
            echo "   âŒ $ORGAN (PID: $PID) - å·²åœæ­¢"
        fi
    fi
done || echo "   æ²¡æœ‰æ‰¾åˆ° PID æ–‡ä»¶"
echo ""

echo "ðŸ“Š [Latest Results] æœ€æ–°è¯„ä¼°ç»“æžœ (5000 æ­¥):"
echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
for organ in foot chest head abdomen pancreas; do
    EVAL_FILE=$(ls -t output/*_${organ}_3views_bino/eval/iter_005000/eval2d_render_test.yml 2>/dev/null | head -1)
    if [ -f "$EVAL_FILE" ]; then
        PSNR=$(grep "^psnr_2d:" "$EVAL_FILE" | awk '{print $2}')
        SSIM=$(grep "^ssim_2d:" "$EVAL_FILE" | awk '{print $2}')
        printf "   %-10s PSNR: %.4f | SSIM: %.4f\n" "$organ" "$PSNR" "$SSIM"
    fi
done
echo ""
