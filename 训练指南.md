# R²-Gaussian 训练指南

## 环境要求

### 运行环境
- **Conda环境名称**: `r2_gaussian_new`
- **Python版本**: 3.9
- **CUDA版本**: 11.6
- **GPU要求**: NVIDIA RTX 3090 或同等性能GPU

### 环境激活
```bash
conda activate r2_gaussian_new
```

## 训练配置

### 数据集
- **训练数据**: `/home/qyhu/Documents/r2_ours/r2_gaussian/data/369/foot_50_3views.pickle`
- **数据类型**: NAF格式 (SAX-NeRF兼容)
- **扫描部位**: 足部CT数据
- **投影视角**: 3个视角，每个视角50帧投影

### 输出目录
- **基础路径**: `/home/qyhu/Documents/r2_ours/r2_gaussian/output/`
- **命名格式**: `footdd_3_MMDD` (根据日期自动生成)
- **示例**: `footdd_3_1111` (11月11日训练)

## 训练命令

### 完整训练命令
```bash
python train.py \
    -s /home/qyhu/Documents/r2_ours/r2_gaussian/data/369/foot_50_3views.pickle \
    -m /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_$(date +%m%d) \
    --gaussiansN 1 \
    --enable_depth \
    --depth_loss_weight 0.05 \
    --depth_loss_type pearson \
    --pseudo_labels \
    --pseudo_label_weight 0.02 \
    --multi_gaussian_weight 0 \
    --num_additional_views 50
```

### 参数详解

#### 基础参数
- `-s`: 数据源路径，指向pickle格式的训练数据
- `-m`: 模型输出路径，包含检查点、评估结果等

#### 高斯配置
- `--gaussiansN 1`: 使用单个高斯场景进行训练
- `--multi_gaussian_weight 0`: 多高斯损失权重设为0（单高斯模式）

#### 深度约束
- `--enable_depth`: 启用深度约束功能
- `--depth_loss_weight 0.05`: 深度损失权重为0.05
- `--depth_loss_type pearson`: 使用Pearson相关系数作为深度损失类型

#### 伪标签学习
- `--pseudo_labels`: 启用伪标签学习
- `--pseudo_label_weight 0.02`: 伪标签损失权重为0.02
- `--num_additional_views 50`: 生成50个额外视角用于伪标签

## 训练流程

### 1. 准备阶段
```bash
# 确认环境激活
conda activate r2_gaussian_new

# 检查数据文件存在
ls -la /home/qyhu/Documents/r2_ours/r2_gaussian/data/369/foot_50_3views.pickle

# 检查初始化文件
ls -la /home/qyhu/Documents/r2_ours/r2_gaussian/data/369/init_foot_50_3views.npy
```

### 2. 执行训练
```bash
# 进入项目根目录
cd /home/qyhu/Documents/r2_ours/r2_gaussian

# 执行训练命令
python train.py -s /home/qyhu/Documents/r2_ours/r2_gaussian/data/369/foot_50_3views.pickle -m /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_$(date +%m%d) --gaussiansN 1 --enable_depth --depth_loss_weight 0.05 --depth_loss_type pearson --pseudo_labels --pseudo_label_weight 0.02 --multi_gaussian_weight 0 --num_additional_views 50
```

### 3. 监控训练

#### TensorBoard可视化监控
```bash
# 启动TensorBoard（监控单个实验）
conda activate r2_gaussian_new
tensorboard --logdir /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD --port 6006

# 启动TensorBoard（对比多个实验）
tensorboard --logdir /home/qyhu/Documents/r2_ours/r2_gaussian/output/ --port 6006

# 后台启动TensorBoard
nohup tensorboard --logdir /home/qyhu/Documents/r2_ours/r2_gaussian/output/ --port 6006 --host 0.0.0.0 > tensorboard.log 2>&1 &
```

#### 远程访问TensorBoard (6006端口)

**方式1: SSH端口转发（推荐）**
```bash
# 在本地机器上运行此命令
ssh -L 6006:localhost:6006 用户名@服务器IP地址

# 然后在本地浏览器访问
# http://localhost:6006
```

**方式2: 直接访问（需要防火墙开放）**
```bash
# 在浏览器访问（需要服务器开放6006端口）
# http://服务器IP地址:6006
```

**方式3: 命令行监控脚本**
```bash
# 创建实时监控脚本
cat > monitor_training.sh << 'EOF'
#!/bin/bash
while true; do
    echo "=== $(date) ==="
    echo "训练进程状态:"
    ps aux | grep "train.py" | grep -v grep
    echo "GPU使用情况:"
    nvidia-smi | head -10
    echo "最新损失值:"
    if [ -f "output/*/events.out.tfevents.*" ]; then
        ls -t output/*/events.out.tfevents.* | head -1
    fi
    sleep 30
done
EOF
chmod +x monitor_training.sh
./monitor_training.sh
```

#### TensorBoard使用指南

**监控内容:**
- **Scalars**: 损失曲线、PSNR/SSIM指标、学习率变化
- **Images**: 渲染结果对比、深度图可视化
- **Histograms**: 参数分布、梯度统计
- **Graphs**: 计算图结构

**关键指标:**
- `loss_total`: 总损失趋势（应持续下降）
- `psnr_2d/psnr_3d`: PSNR值（目标>28）
- `ssim_2d/ssim_3d`: SSIM值（目标>0.90）
- `opacity_mean`: 透明度变化
- `scale_mean`: 高斯尺度统计

**实验对比:**
- 不同参数配置的并行对比
- 训练收敛速度分析
- 最终指标性能对比

#### 查看输出目录结构
```bash
# 查看训练输出结构
ls -la /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD/

# 实时查看训练日志
tail -f /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD/train.log

# 检查TensorBoard日志
ls -la /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD/events.out.tfevents.*
```

## 预期输出

### 训练时间
- **预计时间**: 5-15分钟 (RTX 3090)
- **快速预览**: 3分钟可获得初步结果

### 输出文件结构
```
output/footdd_3_MMDD/
├── cfg_args                # 训练配置参数
├── cfg_args.yml           # YAML格式配置
├── ckpt/                  # 模型检查点
├── eval/                  # 评估结果
├── events.out.tfevents.*  # TensorBoard日志
└── point_cloud/           # 点云数据
```

### 关键指标
- **PSNR**: 峰值信噪比 (越高越好)
- **SSIM**: 结构相似性指标 (越接近1越好)
- **3D重建精度**: 体积重建质量评估

## 训练后处理

### 模型评估
```bash
# 详细评估
python test.py -m /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD

# 生成深度图
python generate_depth_maps.py /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_MMDD

# 生成深度图示例（使用已训练模型）
python generate_depth_maps.py /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd0.02_3_1103

# 绘制评估曲线
python plot_eval_curve_psnr_ssim.py
```

### 可视化结果
```bash
# 可视化点云
python scripts/visualize_scene.py -s /home/qyhu/Documents/r2_ours/r2_gaussian/data/369/foot_50_3views.pickle

# 体积切片对比
python scripts/plot_volume.py
```

## 深度图生成详解

### 深度图功能说明
深度图生成是R²-Gaussian项目中的重要分析工具，用于可视化和验证3D重建的几何一致性。

### 深度图生成命令
```bash
# 基本语法
python generate_depth_maps.py <模型输出路径>

# 使用当前训练的模型
python generate_depth_maps.py /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd_3_$(date +%m%d)

# 使用已有训练好的模型示例
python generate_depth_maps.py /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd0.02_3_1103
```

### 深度图输出内容
生成的深度图会保存在模型输出目录的`depth_maps/`子文件夹中：

```
output/footdd0.02_3_1103/
└── depth_maps/
    ├── all_depth_maps.png          # 所有视角深度图的组合显示
    ├── depth_map_view_000.png      # 第一个视角的深度图
    ├── depth_map_view_001.png      # 第二个视角的深度图
    └── depth_map_view_002.png      # 第三个视角的深度图
```

### 深度图分析意义

#### 1. 几何一致性验证
- **多视角一致性**：检查不同视角下深度信息的一致性
- **重建质量评估**：深度图的清晰度反映3D重建的准确性
- **边缘保持**：观察重要解剖结构的边界是否保持完整

#### 2. 深度约束效果验证
- **深度损失影响**：`depth_loss_weight 0.05`参数的作用效果
- **Pearson相关性**：验证`depth_loss_type pearson`的优化效果
- **几何准确性**：确认重建的3D几何与真实解剖结构匹配

#### 3. 训练质量诊断
- **收敛程度**：深度图的平滑性反映训练收敛状态
- **异常检测**：识别重建中的伪影或不合理区域
- **参数调优**：为后续训练提供参数调整依据

### 深度图读取指南

#### 颜色编码
- **近距离**：通常显示为暖色调（红色、黄色）
- **远距离**：通常显示为冷色调（蓝色、紫色）
- **渐变区域**：表示平滑的深度过渡
- **突变区域**：表示物体边界或深度不连续

#### 质量评估标准
1. **边缘清晰度**：重要解剖结构边界是否清楚
2. **深度连续性**：相邻区域深度是否平滑过渡
3. **多视角一致性**：不同视角深度信息是否协调
4. **细节保持**：小型解剖结构是否被正确重建

### 故障排除

#### 深度图质量差的可能原因
```bash
# 1. 深度损失权重过低
--depth_loss_weight 0.1  # 尝试增加权重

# 2. 训练不充分
--iterations 50000  # 延长训练时间

# 3. 密度控制过早停止
--densify_until_iter 20000  # 延长密度控制时间
```

#### 重新生成深度图
```bash
# 如果深度图生成失败，检查模型完整性
python test.py -m /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd0.02_3_1103

# 确认检查点文件存在
ls -la /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd0.02_3_1103/ckpt/

# 重新生成深度图
python generate_depth_maps.py /home/qyhu/Documents/r2_ours/r2_gaussian/output/footdd0.02_3_1103
```

## 常见问题

### 1. 环境问题
```bash
# 如果CUDA扩展未编译
cd r2_gaussian/submodules/xray-gaussian-rasterization-voxelization
python setup.py install
```

### 2. 内存不足
- 减少`--num_additional_views`参数
- 降低`--densify_grad_threshold`参数

### 3. 训练速度慢
- 设置`--densify_until_iter 0`禁用密度控制
- 调整`--densify_grad_threshold`参数

## 技术说明

### 深度约束原理
- 利用多视角几何一致性
- Pearson相关系数衡量深度一致性
- 提升重建质量和几何准确性

### 伪标签学习
- 从额外50个视角生成监督信号
- 增强训练数据的多样性
- 提升模型泛化能力

### 单高斯配置
- `gaussiansN=1`使用单一高斯场景
- 适合足部这种相对简单的解剖结构
- 平衡训练效率和重建质量